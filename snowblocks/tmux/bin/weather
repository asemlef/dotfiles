#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

# variables
city_id="5809844"   # Seattle
api_key="6fbde35bc10b3a1e3e3c60c42c82176b"
url="http://api.openweathermap.org/data/2.5/weather?APPID=$api_key&id=$city_id&units=imperial"
cache_file="$HOME/.tmux/.weather_cache"
cache_time=10   # in minutes

# fetch data from API
if [[ -f $cache_file ]]; then
    curtime=$(date +%s)
    file_curtime=$(date -r "$cache_file" +%s)
    roundedtime=$(($curtime - ($curtime % ($cache_time * 60))))
    file_roundedtime=$(($file_curtime - ($file_curtime % ($cache_time * 60))))
    if (( $roundedtime == $file_roundedtime )); then
        weather_data=$(cat $cache_file)
    else
        weather_data=$(curl --silent $url)
        echo $weather_data > $cache_file
  	fi
else
    weather_data=$(curl --silent $url)
    echo $weather_data > $cache_file
fi

# parse temperature
weather_temperature=$(echo $weather_data | jq .main.temp | cut -d . -f 1)

# parse weather conditions for best category to use
weather_con_highest=0
for w in $(echo $weather_data | jq -c ".weather | .[]"); do
    weather_con_id=$(echo $w | jq .id)
    weather_con_icon=$(echo $w | jq .icon)

    ### extreme weather
    # hurricane & tropical storm
    if [[ $weather_con_id == "901" ]] | [[ $weather_con_id == "902" ]] || [[ $weather_con_id == "962" ]]; then
        if [[ $weather_con_highest -lt 100 ]]; then
            weather_icon=''
            weather_color='#dc322f' # red
            weather_con_highest=100
        fi
    # tornado
    elif [[ $weather_con_id == "781" ]] || [[ $weather_con_id == "900" ]]; then
        if [[ $weather_con_highest -lt 100 ]]; then
            weather_icon=''
            weather_color='#dc322f' # red
            weather_con_highest=100
        fi

    ### snow & sleet
    # sleet
    elif [[ $weather_con_id =~ ^61[1-2] ]]; then
        if [[ $weather_con_highest -lt 99 ]]; then
            weather_icon=''
            weather_color='#eee8d5' # white
            weather_con_highest=99
        fi
    # snow
    elif [[ $weather_con_id =~ ^6[0-9][0-9] ]]; then
        if [[ $weather_con_highest -lt 98 ]]; then
            weather_icon=''
            weather_color='#eee8d5' # white
            weather_con_highest=98
        fi

    ### thunderstorm
    elif [[ $weather_con_id =~ ^2[0-9][0-9]$ ]]; then
        if [[ $weather_con_highest -lt 80 ]]; then
            weather_icon=''
            weather_color='#d7d700' # bright yellow
            weather_con_highest=80
        fi

    ### rain
    # light rain
    elif [[ $weather_con_id =~ ^3[0-9][0-9]$ ]] || [[ $weather_con_id == "500" ]]; then
        if [[ $weather_con_highest -lt 79 ]]; then
            weather_icon=''
            weather_color='#5fafff' # light blue
            weather_con_highest=79
        fi
    # heavy rain
    elif [[ $weather_con_id =~ ^5[0-9][0-9]$ ]]; then
        if [[ $weather_con_highest -lt 78 ]]; then
            weather_icon=''
            weather_color='#5fafff' # light blue
            weather_con_highest=78
        fi

    ### atmospheric conditions
    # smoke
    elif [[ $weather_con_id == "711" ]]; then
        if [[ $weather_con_highest -lt 69 ]]; then
            weather_icon=''
            weather_color='#afaf87' # smoky grey
            weather_con_highest=69
        fi
    # dust
    elif [[ $weather_con_id == "761" ]]; then
        if [[ $weather_con_highest -lt 69 ]]; then
            weather_icon=''
            weather_color='#afaf87' # smoky grey
            weather_con_highest=69
        fi
    # generic fog
    elif [[ $weather_con_id =~ ^7[0-9][0-9]$ ]]; then
        if [[ $weather_con_highest -lt 60 ]]; then
            weather_icon=''
            weather_color='#afaf87' # smoky grey
            weather_con_highest=60
        fi

    ### cloudy
    # heavy clouds
    elif [[ $weather_con_id == "804" ]]; then
        if [[ $weather_con_highest -lt 59 ]]; then
            weather_icon=''
            weather_color='#87afd7' # lighter blue
            weather_con_highest=59
        fi
    # light clouds
    elif [[ $weather_con_id =~ ^80[1-9]$ ]]; then
        if [[ $weather_con_highest -lt 50 ]]; then
            weather_icon=''
            weather_color='#87afd7' # lighter blue
            weather_con_highest=50
        fi

    ### clear
    elif [[ $weather_con_id == 800 ]]; then
        if [[ $weather_con_highest -lt 1 ]]; then
            if [[ "${weather_con_icon//\"}" = *'d' ]]; then
                weather_icon=''
                weather_color='#d78700' # orange
            elif [[ "${weather_con_icon//\"}" = *'n' ]]; then
                weather_icon=''
                weather_color='#5f87af' # steel blue
            else
                weather_icon='C'
                weather_color='#dc322f' # red
            fi
            weather_con_highest=1
        fi

    ### catchall for unexpected state
    else
        weather_icon='?'
        weather_color='#dc322f' # red
    fi
done

# print weather info formatted for tmux
echo "#[fg=#93a1a1]${weather_temperature}°F #[fg=${weather_color}]${weather_icon} #[fg=default]"
